language: python
python:
  - 2.7

sudo: false
cache:
  timeout: 3600
  pip: true
  directory:
  - ${HOME}/google_appengine
  - ${HOME}/google-cloud-sdk

env:
  - TEST_DIR=tests/docs;
      GAE_PYTHONPATH=${HOME}/.cache/google_appengine;
      PATH=$PATH:${HOME}/google-cloud-sdk/bin;
      PYTHONPATH=${PYTHONPATH}:${GAE_PYTHONPATH};
      CLOUDSDK_CORE_DISABLE_PROMPTS=1;
  - TEST_DIR=tests/notebooks

# command to install dependencies
install:
  - pip install --upgrade pip;
  - pip install -r requirements.txt
  - git clone https://github.com/simpeg/simpeg.git
  - cd simpeg; git checkout dev; git pull; python setup.py build_ext --inplace; cd ..
  - export PATH=$PWD/simpeg:$PATH

# command to run tests
script:
  - nosetests $TEST_DIR

after_success:
  - if [ "$TEST_DIR" = "tests/docs" ]; then
      if [ "$TRAVIS_BRANCH" = "gae-deploy" -a "$TRAVIS_PULL_REQUEST" = "false" ]; then
        openssl aes-256-cbc -K $encrypted_c85711639858_key -iv $encrypted_c85711639858_iv -in docs/credentials.tar.gz.enc -out credentials.tar.gz -d
        tar -xvzf credentials.tar.gz
        GAE_PYTHONPATH=${HOME}/.cache/google_appengine ;
        export PATH=$PATH:${HOME}/google-cloud-sdk/bin ;
        export PYTHONPATH=${PYTHONPATH}:${GAE_PYTHONPATH} ;
        python _ext/fetch_gae_sdk.py $(dirname "${GAE_PYTHONPATH}") ;
        if [ ! -d ${HOME}/google-cloud-sdk ]; then
           curl https://sdk.cloud.google.com | bash;
        fi ;
        gcloud auth activate-service-account --key-file client-secret.json ;
        gcloud config set project simpegtutorials ;
        gcloud -q components update gae-python ;
        gcloud -q preview app deploy ./app.yaml --version ${TRAVIS_COMMIT} --promote;
      fi;
    fi

notifications:
  email:
    - lindseyheagy@gmail.com
